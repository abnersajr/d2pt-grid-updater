name: Run Grid Updater Every 3 Hours

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:
    inputs:
      backfill_hashes:
        description: 'Regenerate all MD5 hashes for existing grid files'
        required: false
        default: false
        type: boolean
permissions:
  contents: write

jobs:
  run-grid-updater:
    concurrency:
      group: grid-updater
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.0"
      - name: Install dependencies
        run: bun install
      - name: Backfill grid hashes (if requested)
        if: github.event.inputs.backfill_hashes == 'true'
        run: bun run generate_hashes.ts
      - name: Run grid updater
        run: bun run grid-updater.ts
      - name: Commit and push changes
        run: |
          set -e
          git config user.name "Abner Soares Alves Junior"
          git config user.email "abnersajr@gmail.com"

          if git status --porcelain | grep . >/dev/null; then
            patch=""
            date=""
            if [ -f last_update.txt ]; then
              patch=$(sed -n '1p' last_update.txt | tr -d '\r')
              date=$(sed -n '2p' last_update.txt | tr -d '\r')
            fi
            if [ -z "$patch" ] || [ -z "$date" ]; then
              if [ -f grids.md ]; then
                first_row=$(awk 'found && NF{print; exit} /^\|[[:space:]-|]+$/{found=1}' grids.md)
                if [ -n "$first_row" ]; then
                  date=$(printf "%s" "$first_row" | awk -F"|" '{gsub(/^ +| +$/,"",$2); print $2}')
                  patch=$(printf "%s" "$first_row" | awk -F"|" '{gsub(/^ +| +$/,"",$3); print $3}')
                fi
              fi
            fi

            msg="update: day ${date:-unknown_date} patch ${patch:-unknown_patch}"
            echo "Committing with message: $msg"
            git add -A
            if git diff --staged --quiet; then
              echo "No changes to commit after staging."
              exit 0
            fi
            git commit -m "$msg"
            git push
          else
            echo "No changes detected."
          fi
